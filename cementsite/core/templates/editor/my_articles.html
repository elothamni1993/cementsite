{% extends "base.html" %}
{% block title %}My Articles{% endblock %}

{# Page-specific CSS inline #}
{% block extra_css %}
<style>
  .toolbar { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; margin:.6rem 0 1rem; }
  .toolbar form { margin-left:auto; display:flex; gap:.4rem; align-items:center; }
  .toolbar input[type="text"], .toolbar select {
    padding:.5rem .6rem; border:1px solid #e5e7eb; border-radius:8px;
  }

  .table-basic { width:100%; border-collapse:separate; border-spacing:0 8px; }
  .table-basic th { text-align:left; font-weight:600; color:#374151; padding:.5rem .6rem; position:sticky; top:0; background:#f8fafc; z-index:1; border-bottom:1px solid #e5e7eb; }
  .table-basic td { background:#fff; border:1px solid #e5e7eb; border-left:0; border-right:0; padding:.6rem .6rem; }
  .table-basic tr td:first-child { border-left:1px solid #e5e7eb; border-top-left-radius:10px; border-bottom-left-radius:10px; }
  .table-basic tr td:last-child { border-right:1px solid #e5e7eb; border-top-right-radius:10px; border-bottom-right-radius:10px; }
  .table-basic tbody tr:hover td { background:#f9fafb; }

  .chip { display:inline-block; font-size:.75rem; padding:.15rem .5rem; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; color:#374151; }
  .chip-ok   { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
  .chip-warn { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }

  .pager { display:flex; gap:.8rem; align-items:center; justify-content:center; margin-top:1rem; }
  .pager a { text-decoration:none; color:#111827; border:1px solid #e5e7eb; padding:.35rem .6rem; border-radius:8px; }
  .pager span { color:#6b7280; }

  .empty-state { text-align:center; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:2rem; }
  .btn { display:inline-block; padding:.7rem 1rem; border-radius:10px; text-decoration:none; font-weight:700; }
  .btn-primary { background:#111827; color:#fff; }
  .btn-ghost { background:#fff; color:#111827; border:1px solid #e5e7eb; }

  .muted { color:#6b7280; }
</style>
{% endblock %}

{% block content %}
<h1>My Articles</h1>

<div class="toolbar">
  <a class="btn btn-primary" href="{% url 'article_new_public' %}">+ New Article</a>

  <form method="get">
    <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Search title…">
    <select name="status">
      <option value="">All</option>
      <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>Published</option>
      <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
    </select>
    <button class="btn btn-ghost" type="submit">Filter</button>
  </form>
</div>

<p class="muted" style="margin:.2rem 0 1rem;">
  {% if request.GET.q %}Search: “{{ request.GET.q }}” · {% endif %}
  {% if request.GET.status %}Status: {{ request.GET.status|title }} · {% endif %}
  Results: {{ page_obj.paginator.count }}
</p>

{% if page_obj.object_list %}
<table class="table-basic">
  <thead>
    <tr>
      <th>Title</th>
      <th>Status</th>
      <th>Access</th>
      <th>Created</th>
      <th style="text-align:right;">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for a in page_obj.object_list %}
    <tr>
      <td><a href="{% url 'article_detail' a.slug %}">{{ a.title }}</a></td>
      <td>
        {% if a.published %}
          <span class="chip chip-ok">Published</span>
        {% else %}
          <span class="chip chip-warn">Draft</span>
        {% endif %}
      </td>
      <td><span class="chip">{{ a.access_level|title }}</span></td>
      <td>{{ a.created_at|date:"Y-m-d H:i" }}</td>
      <td style="text-align:right;">
        <a href="{% url 'article_edit_public' a.slug %}">Edit</a>
        <form method="post" action="{% url 'article_delete_public' a.slug %}"
              style="display:inline;margin-left:.6rem;" class="js-del">
          {% csrf_token %}
          <button type="submit" style="background:none;border:0;color:#b91c1c;cursor:pointer;">Delete</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="pager">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&status={{ request.GET.status }}">← Prev</a>
  {% endif %}
  <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&status={{ request.GET.status }}">Next →</a>
  {% endif %}
</div>

{% else %}
<div class="empty-state">
  <h3>No articles yet</h3>
  <p class="muted">Start your first post—admins will review and publish.</p>
  <a class="btn btn-primary" href="{% url 'article_new_public' %}">Write your first article</a>
</div>
{% endif %}
{% endblock %}

{# Page-specific JS inline #}
{% block extra_js %}
<script>
  // Confirm + disable delete button after submit
  document.addEventListener('click', function(e){
    const btn = e.target.closest('form.js-del button[type="submit"]');
    if (!btn) return;
    if (!confirm('Delete this article?')) {
      e.preventDefault();
    } else {
      btn.disabled = true;
    }
  });

  // Submit on Enter in search field without losing other filters
  const q = document.querySelector('.toolbar input[name="q"]');
  if (q) {
    q.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        this.form.requestSubmit();
      }
    });
  }
</script>
{% endblock %}
